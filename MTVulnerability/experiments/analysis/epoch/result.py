"""
Protocol:
Setting S7,S11,S12: Resnet18, no-weight, steps: 25, epsilon: 16
Query:
 yamizi/robust-mtl-rq => S7_25_Vanilla_epsilon
 yamizi/iccv21-adv => S7_25_Vanilla_epsilon

1)
Run the mono-task attacks on a all 2-tasks combinations training from (s,n,p,r,k,K,d,D,A,e,E)
For different values of epsilon on the Vanilla attack

2)
Run the two-task attacks on a all 2-tasks combinations training from (s,n,p,r,k,K,d,D,A,e,E)
For different values of epsilon on the Vanilla attack
"""
import pandas as pd
from experiments import load_json
import matplotlib.pyplot as plt

base_folder = [".","output","experiments","attacks"]
targets = ["s","n","p","r","k","K","d","D","A","e","E"]
targets = ["s","E","d","D","n"]

def boxplot_resnet18_noW_vanilla():

    data_s7 = load_json(to_df=True, attack="Vanilla", setting="S7_25_eps", targets=targets)
    data_s7 = data_s7[data_s7["col3"]=="16"]
    data_s7["epoch"] = "150"
    data_s11 = load_json(to_df=True, attack="Vanilla", setting="S11_25", targets=targets)
    data_s11["epoch"] = "50"
    data_s12 = load_json(to_df=True, attack="Vanilla", setting="S12_25", targets=targets)
    data_s12["epoch"] = "100"


    data = pd.concat([data_s7, data_s11, data_s12])
    filtered = data[data["model"]=="bi"]
    filtered.loc[filtered.measured == "s", 'values_last'] = 100 - filtered.loc[filtered.measured == "s", 'values_last']
    filtered.loc[filtered.measured == "s", 'values_first'] = 100 - filtered.loc[
        filtered.measured == "s", 'values_first']
    filtered["relative_change"] = (filtered["values_last"] - filtered["values_first"]) / filtered["values_first"]
    filtered["model"] = filtered["attack"] + " " + filtered["epoch"]

    target = "all tasks"
    final = filtered[["model", "relative_change"]]
    ax = final.boxplot(by="model", positions=[1, 2, 0, 4, 5, 3])  # ,positions=[3,0,1,2,7,4,5,6])
    title = "relative change of error for {}".format(target)
    ax.set_title(title)

    ax = filtered[["model", "values_first"]].boxplot(by="model", positions=[1, 2, 0, 4, 5,
                                                                                   3])  # ,positions=[3,0,1,2,7,4,5,6])
    title = "Clean error for {}".format(target)
    ax.set_title(title)

    ax = filtered[["model", "values_last"]].boxplot(by="model", positions=[1, 2, 0, 4, 5,
                                                                                  3])  # ,positions=[3,0,1,2,7,4,5,6])
    title = "Adversarial error for {}".format(target)
    ax.set_title(title)

    for target in targets:
        filtered_target = filtered[filtered["measured"]==target]
        final = filtered_target[["model", "relative_change"]]
        ax = final.boxplot(by="model", positions=[1,2,0,4,5,3])#,positions=[3,0,1,2,7,4,5,6])
        title = "relative change of error for {}".format(target)
        ax.set_title(title)

        ax = filtered_target[["model", "values_first"]].boxplot(by="model", positions=[1, 2, 0, 4, 5, 3])  # ,positions=[3,0,1,2,7,4,5,6])
        title = "Clean error for {}".format(target)
        ax.set_title(title)

        ax = filtered_target[["model", "values_last"]].boxplot(by="model", positions=[1, 2, 0, 4, 5, 3])  # ,positions=[3,0,1,2,7,4,5,6])
        title = "Adversarial error for {}".format(target)
        ax.set_title(title)

    print(data.columns)


boxplot_resnet18_noW_vanilla()

plt.show()
